<div id="panelDetalles" [class.abierto]="abierto">
  <div id="panelDetallesContent">
    <button (click)="onCerrar()" class="btn-cerrar">
      <i class="fas fa-times"></i>
    </button>
    <h2>Detalles de Tarea</h2>

    <!-- Mensaje si no puede editar -->
    <div *ngIf="!puedeEditar" class="alert-solo-lectura-panel">
      <i class="fas fa-eye"></i>
      <span>Solo puedes ver esta tarea. No tienes permisos para editarla.</span>
    </div>

    <form (ngSubmit)="onSubmit()">
      <!-- Fieldset deshabilita todos los inputs cuando !puedeEditar -->
      <fieldset [disabled]="!puedeEditar" style="border: none; margin: 0; padding: 0">
        <label for="nombre"> <i class="fas fa-tag"></i> Nombre: </label>
        <input
          type="text"
          id="nombre"
          [(ngModel)]="nombre"
          name="nombre"
          placeholder="+ Agregar una tarea"
          required
        />

        <label for="descripcion"> <i class="fas fa-align-left"></i> Descripci√≥n: </label>
        <input type="text" id="descripcion" [(ngModel)]="descripcion" name="descripcion" />

        <label> <i class="fas fa-list-ol"></i> Pasos: </label>
        <div id="contenedorPasos">
          <div *ngFor="let paso of pasos; let i = index; trackBy: trackByIndex" class="paso-item">
            <i class="fas fa-grip-vertical paso-drag-icon"></i>
            <input
              type="text"
              [(ngModel)]="pasos[i]"
              [name]="'paso-' + i"
              [id]="'paso-input-' + i"
              placeholder="Escribe el paso y presiona Enter para agregar otro"
              class="paso-input"
              (keydown.enter)="agregarPasoDesdeEnter(i, $event)"
            />
            <button type="button" (click)="eliminarPaso(i)" class="btn-eliminar-paso" tabindex="-1">
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
        </div>
        <button type="button" (click)="agregarPaso()" class="btn-agregar-paso" tabindex="-1">
          <i class="fas fa-plus"></i> Agregar paso
        </button>
        <br /><br />

        <label> <i class="fas fa-star"></i> Agregar a: </label>
        <div class="agregar-a-section">
          <div class="checkbox-group">
            <input type="checkbox" id="miDia" [(ngModel)]="miDia" name="miDia" />
            <label for="miDia" class="checkbox-label"> <i class="fas fa-sun"></i> Mi d√≠a </label>
          </div>
        </div>

        <label for="listaSelect"> <i class="fas fa-layer-group"></i> Lista: </label>
        <app-dropdown-lista
          [listas]="listas"
          [(ngModel)]="idLista"
          name="listaSelect"
          placeholder="Sin lista"
        >
        </app-dropdown-lista>

        <label for="prioridad"> <i class="fas fa-flag"></i> Prioridad: </label>
        <select id="prioridad" [(ngModel)]="prioridad" name="prioridad">
          <option value="N">Normal</option>
          <option value="A">Alta</option>
          <option value="B">Baja</option>
        </select>

        <label for="recordatorio"> <i class="fas fa-bell"></i> Recordarme: </label>
        <select
          id="recordatorio"
          [(ngModel)]="recordatorio"
          name="recordatorio"
          (change)="onRecordatorioChange()"
        >
          <option value="0">No recordar</option>
          <option value="1">M√°s tarde (2 horas)</option>
          <option value="2">Ma√±ana (9:00 AM)</option>
          <option value="3">Semana Pr√≥xima (Lunes 9:00 AM)</option>
          <option value="4">Elegir fecha y hora</option>
        </select>

        <!-- ‚úÖ Campos de fecha y hora para recordatorio personalizado -->
        <div class="fecha-hora-group" *ngIf="recordatorio === '4'">
          <div class="input-group">
            <label for="fechaRecordatorio">üìÖ Fecha</label>
            <input
              type="date"
              id="fechaRecordatorio"
              [(ngModel)]="fechaRecordatorio"
              name="fechaRecordatorio"
              [required]="recordatorio === '4'"
            />
          </div>
          <div class="input-group">
            <label for="horaRecordatorio">üïê Hora</label>
            <input
              type="time"
              id="horaRecordatorio"
              [(ngModel)]="horaRecordatorio"
              name="horaRecordatorio"
              [required]="recordatorio === '4'"
            />
          </div>
        </div>

        <!-- ‚úÖ Lista de recordatorios programados -->
        <div class="recordatorios-lista" *ngIf="recordatoriosAgregados.length > 0">
          <label><i class="fas fa-list"></i> Recordatorios programados:</label>
          <div class="recordatorio-item" *ngFor="let rec of recordatoriosAgregados; let i = index">
            <i class="fas fa-bell"></i>
            <span>{{ formatearFechaHora(rec.fecha) }}</span>
            <span class="recordatorio-tipo">({{ obtenerTextoTipo(rec.tipo) }})</span>
            <button
              type="button"
              (click)="eliminarRecordatorioLocal(i)"
              class="btn-eliminar-recordatorio"
              title="Eliminar recordatorio"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <label for="selectFechaVencimiento">
          <i class="far fa-calendar-alt"></i> Fecha de vencimiento:
        </label>
        <select
          id="selectFechaVencimiento"
          [(ngModel)]="selectFechaVencimiento"
          name="selectFechaVencimiento"
          (change)="onSelectFechaVencimientoChange()"
        >
          <option value="0">Sin fecha</option>
          <option value="1">Hoy</option>
          <option value="2">Ma√±ana</option>
          <option value="3">Semana Pr√≥xima</option>
          <option value="4">Elegir fecha</option>
        </select>
        <input
          *ngIf="selectFechaVencimiento === '4'"
          type="date"
          id="fechaVencimiento"
          [(ngModel)]="fechaVencimiento"
          name="fechaVencimiento"
        />

        <label for="repetir"> <i class="fas fa-redo"></i> Repetir: </label>
        <div class="checkbox-group">
          <input type="checkbox" id="repetir" [(ngModel)]="repetir" name="repetir" />
          <label for="repetir" class="checkbox-label"></label>
        </div>
        <select
          id="tipoRepeticion"
          [(ngModel)]="tipoRepeticion"
          name="tipoRepeticion"
          [disabled]="!repetir"
        >
          <option value="diario">Diariamente</option>
          <option value="laborales">D√≠as laborales</option>
          <option value="semanal">Semanalmente</option>
          <option value="mensual">Mensualmente</option>
          <option value="personalizado">Personalizado</option>
        </select>

        <div *ngIf="repetir && tipoRepeticion === 'personalizado'" id="configPersonalizada">
          <label for="repetirCada">Cada:</label>
          <input
            type="number"
            id="repetirCada"
            [(ngModel)]="repetirCada"
            name="repetirCada"
            min="1"
          />
          <select id="repetirUnidad" [(ngModel)]="repetirUnidad" name="repetirUnidad">
            <option value="dias">D√≠a(s)</option>
            <option value="semanas">Semana(s)</option>
            <option value="meses">Mes(es)</option>
            <option value="a√±os">A√±o(s)</option>
          </select>
        </div>

        <label for="notas"> <i class="fas fa-sticky-note"></i> Notas: </label>
        <textarea id="notas" [(ngModel)]="notas" name="notas" rows="4"></textarea>
      </fieldset>

      <!-- Botones fuera del fieldset -->
      <div class="form-buttons">
        <button type="submit" class="btn-guardar" [disabled]="!puedeEditar">
          <i class="fas fa-save"></i>
          {{ modoEdicion ? 'Actualizar' : 'Guardar' }}
        </button>
        <button type="button" (click)="onCerrar()" class="btn-cancelar">
          <i class="fas fa-times"></i> Cancelar
        </button>
      </div>
    </form>
  </div>
</div>